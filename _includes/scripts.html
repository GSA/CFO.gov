<!-- Digital Analytics Program roll-up, see https://analytics.usa.gov for data -->

<script type="text/javascript" src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<!-- <script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script> -->
<!-- <script>var $j = $.noConflict(true);</script> -->

<script src="https://code.jquery.com/jquery-migrate-3.4.1.min.js"></script>
<script id="_fed_an_ua_tag" src="https://dap.digitalgov.gov/Universal-Federated-Analytics-Min.js?agency=GSA"></script>
<script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>
<script src="{{ site.baseurl }}/assets/js/isotope.pkgd.min.js"></script>
<script src="{{ site.baseurl }}/assets/js/isotope.settings.js"></script>
<script src="{{ site.baseurl }}/assets/js/pdfkit.js"></script>
<script src="{{ site.baseurl }}/assets/js/blob-stream.js"></script>
{% include searchgov/script.html affiliate=site.searchgov_affiliate %}

<script src="{{ site.baseurl }}/assets/js/uswds.min.js?{{ site.time | date: '%s%N' }}"></script>
<script src="{{ site.baseurl }}/assets/js/app.js?{{ site.time | date: '%s%N' }}"></script>
<script type="text/javascript">
    window.federalist = {
      path: {
        baseurl: '{{ site.baseurl }}'
      }
    };
</script>
{% if page.attached %}
{% for file in page.attached %}
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/{{ file }}.js"></script>
{% endfor %}
{% endif %}

<script type="text/javascript" src="{{ site.baseurl }}/assets/js/slick.js?{{ site.time | date: '%s%N' }}"></script>
<script type="text/javascript" src="{{ site.baseurl }}/assets/js/magnific-popup.js?{{ site.time | date: '%s%N' }}"></script>

<script type="text/javascript">
    jQuery(document).ready(function () {
        jQuery('.top').slick({
            lazyLoad: 'ondemand', // ondemand progressive anticipated
            infinite: true,
            autoplay: true,
            autoplaySpeed: 6000,
            dots: true,
            arrows: false
        });
        jQuery('.image-link').magnificPopup({
            type: 'inline',
            midClick: true
        });

        if (/career\-planning\-tool/.test(window.location.href)) {
            jQuery('button[type="button"], button[type="submit"]').createButtonEvents();
        }
        if (/training\-resources/.test(window.location.href)) {
            jQuery('button[type="button"], button[type="submit"]').createButtonEvents();
        }
    });

</script>
<script src="{{ site.baseurl }}/assets/js/cfo-tabs.js?{{ site.time | date: '%s%N' }}"></script>
{% if page.url == '/training-resources/' %}
<script type="text/javascript" src="https://cdn.datatables.net/2.0.7/js/dataTables.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/5.0.0/js/dataTables.fixedColumns.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/5.0.0/js/fixedColumns.dataTables.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/select/2.0.2/js/dataTables.select.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.dataTables.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
<script type="text/javascript" src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>

{% assign jsonData = site.data.coursesJ %}
{% assign columns = site.data.columns %}
<!-- <script type="text/javascript" src="{{ site.baseurl }}/assets/js/facets/facets-filters/training-filters.js"></script> -->
<script>
$(document).ready(function() {
    // Initialize DataTable
    var priceColumn = {{ columns.price }};
    const data = {{ jsonData | jsonify }};

    var table = $('#myTable').DataTable({
        data: data,
        "columns": [
          {
              "className": 'dt-control', "orderable": false, "data": null, "defaultContent": ''
          },
          { data: 'course_title', render: function(data, type, row) { return '<a href="' + (row.link || '#') + '" target="_blank" rel="noopener noreferrer">' + (data || '') + '</a>'; }, "className": "testFind" },
          { data: 'training_providers', defaultContent: '', "className": "testFind" },
          { data: 'course_duration_num', render: function(data, type, row) {return '' + data.toString() + ' ' + row.course_duration_attribute + '';}, defaultContent: '', "className": "testFind"  },
          { data: 'learning_modality', defaultContent: '' },
          { data: 'course_credit_type', render: function(data) { return Array.isArray(data) ? data.join(', ') : (data || ''); }, defaultContent: '' },
          { data: 'price', render: function (data, type, row, meta) { return '$' + data.toLocaleString('en-US', { minimumFractionDigits: 2 });}},
          {
              "orderable": false, "render": DataTable.render.select(), "defaultContent": ''
          },
          { data: 'competency', render: function (data, type, row, meta) { return data.toLowerCase().replace(/[\s,]+/g, '-'); }, defaultContent: '', visible: false},
          { data: 'job_series', defaultContent: '', visible: false},
          { data: 'gs_level', defaultContent: '', visible: false},
        ],
        createdRow: (row, data, index) => {
            row.querySelector(':nth-child(7)').setAttribute("data-filter", data["price"]);
        },
        "select": {
            style: 'os',
            selector: 'td:first-child',
            headerCheckbox: false
        },
        // "searching": false,
        "paging":   true,
        "info":     false,
        "ordering": false // Disable sorting for all columns
    });

    // var data = {{ jsonData | jsonify }};
    //
    // // Populate the table
    // data.forEach(function(item) {
    //   var row = [];
    //   var accordionContent = '';
    //   row.push('accordion');
    //
    //   for (var key in item) {
    //       if (key === 'course_title') {
    //           row.push('<a href="' + item['link'] + '" target="_blank" rel="noopener noreferrer">' + item[key] + '</a>');
    //       } else {
    //           row.push(item[key]);
    //       }
    //   }
    //
    //   table.row.add(row);
    // });

    // Draw the table
    table.draw();

    // Object to store active filters for each column
    var activeFilters = {};
    var minBtn = 0;
    var maxBtn = 0;
    //var searchKeyword = '';

    // Apply toggle functionality to filter buttons
    $('.filterBtn').on('click', function () {
        var $btn = $(this);
        var columnIndex =  $btn.data('column-num');
        var filterValue = $btn.data('filter');
        console.log(columnIndex);
        console.log(filterValue);
        minBtn = $btn.data('min');
        maxBtn = $btn.data('max');

        if (!activeFilters[columnIndex]) {
            activeFilters[columnIndex] = new Set();
        }

        // Toggle active class
        if ($btn.hasClass('active')) {
            $btn.removeClass('active');
            if (columnIndex == priceColumn) {
              activeFilters[columnIndex].delete(minBtn);
            } else {
              activeFilters[columnIndex].delete(filterValue);
            }
        } else {
            $btn.addClass('active');
            if (columnIndex == priceColumn) {
              activeFilters[columnIndex].add(minBtn);
            } else {
              activeFilters[columnIndex].add(filterValue);
            }
        }

        if (activeFilters[columnIndex].has('all')) {
            activeFilters[columnIndex].clear();
            activeFilters[columnIndex].add('all');
        }

        // Apply the filters
        table.draw();
        window.history.replaceState({}, "", "/training-resources/");
    });

    // var createButtonEvents = function ($buttons) {
    //   $buttons.filter("button").each(function () {
    //     const button = $(this);
    //     button.on('click', function (evt) {
    //       evt.preventDefault();
    //       if (button[0].id.match('competency-group-button')) {
    //         $(this).parent().siblings().slideToggle();
    //         $(this).find('i').toggleClass('fa-plus fa-minus');
    //         // Set aria label
    //         let ariaLabel = $(this).find('i').hasClass('fa-plus') ? ', collapsed' : ', expanded';
    //         $(this).attr('aria-label', $(this).text() + ariaLabel);
    //       } else {
    //         if (!ifExists(evt.target.id)) {
    //           console.log("if not");
    //         } else {
    //           // removeCriteria('button', evt.target.id);
    //           console.log("remove crit");
    //         }
    //         if (button[0].id.match('series') || button[0].id.match('GS')) {
    //           // enableDisabledCompetencies();
    //           console.log("enable compet");
    //         }
    //       }
    //     });
    //   });
    // };
    // createButtonEvents($('button'));

    // Event handler for checkboxes
    $('input[type="checkbox"]:not(.dt-select-checkbox)').on('change', function() {
        var $checkbox = $(this);
        var filterValue = $checkbox.data('id');
        var competencyType = $checkbox.data('group');

        if (!activeFilters['competency']) {
            activeFilters['competency'] = new Set();
        }

        if ($checkbox.is(':checked')) {
            activeFilters['competency'].add(filterValue);
        } else {
            activeFilters['competency'].delete(filterValue);
        }
        // Apply the filters
        table.draw();
    });

    function format(d) {
        return (
            '<div class="grid-container">' +
              '<div class="grid-row">' +
                  '<div class="tablet:grid-col">' +
                  '<dl>' +
                  '<dt>Course Description</dt>' +
                  "<p></p>" + //placeholder for empty data
                  // "<p>" + d['course_description'] + "</p>" +
                  '</dl>' +
                  '</div>' +
                  '<div class="tablet:grid-col">' +
                  '<dl>' +
                  '<dt>Additional Course Information</dt>' +
                  "<p></p>" + //placeholder for empty data
                  // "<p>" + d['additional_course_information'] + "</p>" +
                  '</dl>' +
                  '</div>' +
              '</div>' +
            '</div>'
        );
    }

    table.on('click', 'td.dt-control', function (e) {
        let tr = e.target.closest('tr');
        let row = table.row(tr);

        if (row.child.isShown()) {
            row.child.hide();
        }
        else {
            row.child(format(row.data())).show();
        }
    });

    $('#career-download-button-1').on('click', function() {
        var $button = $(this);
        var operation = $button.data('op');

        if (operation === 'select-all') {
            table.rows().select();
            $button.data('op', 'deselect-all').text('DESELECT ALL COURSES');
        } else {
            table.rows().deselect();
            $button.data('op', 'select-all').text('SELECT ALL COURSES');
        }
    });

    // Custom filtering function
    $.fn.dataTable.ext.search.push(
        function(settings, data, dataIndex) {
            // Handle specific column filters
            for (var columnIndex in activeFilters) {
                var filterValues = Array.from(activeFilters[columnIndex]);
                if (filterValues.length > 0 && !filterValues.includes('all')) {
                  var columnData = data[columnIndex];
                  //price range filter
                  if (columnIndex == priceColumn) {
                    columnData = parseFloat(columnData.replace(/\$|,/g, ''));
                    const rangeMappings = {
                        0: [0, 500],
                        500: [500, 1000],
                        1000: [1000, 2000],
                        2000: [2000, 10000]
                    };
                    var isInRange = filterValues.some(filterValue => {
                      if (rangeMappings[filterValue]) {
                          let [min, max] = rangeMappings[filterValue];
                          return columnData >= min && columnData < max;
                      }
                      return filterValue === columnData;
                    });
                    if (!isInRange) {
                        return false;
                    }
                  //filtering for all other columns
                } else if (columnIndex == 'competency') {
                  // Additional checkbox filtering logic
                  var competencyValues = Array.from(activeFilters['competency']);
                  if (competencyValues.length > 0) {
                      var found = competencyValues.some(value => {
                          return data.some(columnData => columnData.includes(value));
                      });
                      if (!found) {
                          return false;
                      }
                  }
                } else {
                    if (!filterValues.includes(columnData)) {
                        return false;
                    }
                  }
                }
            }
            return true;
        }
    );

    // $.fn.dataTable.ext.search.push(
    //     function(settings, data, dataIndex) {
          
    //       data.forEach(item => {
    //         console.log('item ', item);
    //         if(item.toLowerCase().indexOf(searchKeyword.toLowerCase() != -1)) {
    //           console.log('item before match is true ', item);
    //           match = true;
    //         }
    //       })
    //       return match;
    //   });

   

     $('#career-advancement-search-input-training-resources').autocomplete({
      source: function (request, response) {
        let normalized = request.term.toLowerCase();
        let n = normalized.length + 40;
        
        let outputs = data.map(function (item) {
          let duration = stripHtmlTags(item.course_duration_num + item.course_duration_attribute);
          let value = item.course_title;
          // Search by title
          if (value.toLowerCase().indexOf(normalized) != -1) {
            return stripHtmlTags(value);
          }
          else if (item.training_providers.toLowerCase().indexOf(normalized) != -1) {
            return stripHtmlTags(item.training_providers);
          }
          // Search by Proficiency Level Definition
          else if (duration.toLowerCase().indexOf(normalized) != -1) {
            return duration;
          }
          // Search by Behavioral Illustrations
          else if (item.learning_modality.toLowerCase().indexOf(normalized) != -1) {
            return stripHtmlTags(item.learning_modality);
          }
          else if (item.course_credit_type.toLowerCase().indexOf(normalized) != -1) {
            return stripHtmlTags(item.course_credit_type);
          }
          else if (item.price.toString().indexOf(normalized) != -1) {
            return stripHtmlTags(item.price);
          }
          return null;
        });
        outputs = outputs.filter(function (x) { return !!x }).filter((item, index, self) => self.indexOf(item) === index);
        outputs = outputs.map(str => {
          str = str.substring(str.toLowerCase().indexOf(normalized))
              .split("?")[0]
              .split("|")[0];
          str = str.replace(/[,\s]+$/g, '').trim();
          return str.length > n ? str.substring(0, n) + "..." : str;
        });
        // Filter by unique value.
        outputs = [...new Set(outputs)];
        response(outputs);
      },
      select: function (event, ui) {
        let $elem = $(event.target);
        $elem.val(ui.item.value);
        $('#cfo-search-button-tr').click();
        },
      change: function (event, ui) {
      }
    });

    function stripHtmlTags(str) {
    if (!str || typeof str !== "string") return str;
    return str.replace(/<[^>]*>/g, "|").replace(/&#58;/g, "");
  }

  $('#cfo-search-button-tr').on('click', function () {
    searchKeyword = $("#career-advancement-search-input-training-resources").val().trim().split('...')[0];

    table.search(searchKeyword).draw();
    //table.draw();

    // table.columns().every(function () {
    //   var column = this;
    //   console.log('column? ', column);
    //     column.search(searchKeyword).draw();
    // });

    //.columns(':visible').search(value)
    //table.columns(".testFind").search(searchKeyword).draw();
  })


    // function getSearch () {
    //     // console.log(facetGlobalVars);
    //     var results = [];
    //     let searchKeyword = $("#career-advancement-search-input-training-resources").val().trim();
    //     var searchKeys = ["course_title", "institution", "course_duration", "learning_modality", "course_type", "price"]

    //     // create a count of the the items displayed and display it.
    //     // count all search results for an item as a sanity check and make a spread sheet.
    //             let newResults = [];
    //                 // create a results array for the next search criteria
    //                 data.forEach(item => {
    //                     searchKeys.forEach(term => {
    //                         facetGlobalVars.data.forEach(obj => { // go over the search and facets selected
    //                               let stringToMatch = Array.isArray(item[term]) ? item[term].join(' ') : item[term];
    //                               if (stringToMatch !== null) {
    //                                   stringToMatch = stringToMatch.replace(/[^a-zA-Z0-9\s]/g, "").toLowerCase();
    //                                   if (stringToMatch.match(searchKeyword.toLowerCase().replace(/[^a-zA-Z0-9\s]/g, ""))) {
    //                                       if (!ifExistsResults(item.permalink, newResults)) {
    //                                           newResults.push(item);
    //                                       }
    //                                   }
    //                               }

    //                         });
    //                     });
    //                 });
    //             // look for new filters in prior results set and if they are there
    //             // save the prior results in to a different array.
    //             let finishResults = [];
    //             if (results.length > 0) {
    //                 results.forEach(item => {
    //                     newResults.forEach(newItem => {
    //                         if (item.permalink.toLowerCase() === newItem.permalink.toLowerCase()) {
    //                             if (!ifExistsResults(item.permalink, finishResults)) {
    //                                 finishResults.push(item);
    //                             }
    //                         }
    //                     });
    //                 });
    //             } else {
    //                 finishResults = newResults;
    //             }

    //             // populate results with finishResults
    //             results = [];
    //             finishResults.forEach(item => {
    //                 if (!ifExistsResults(item.title, results)) {
    //                     results.push(item);
    //                 }
    //             });
    //         enableDisableCompetencies(false);
    //         $("#career-search-results").empty();

    //     // if (facetGlobalVars.results.length === 0 && facetGlobalVars.data.length === 0) {
    //     //     facetGlobalVars.results = facetGlobalVars.fullSet;
    //     //     $('#career-facet-remove-all-filters-button').hide();
    //     //     createClearButton();
    //     // }
    // }

    function onHashChange() {

        var indexMap = {};

        indexMap["level"] = {{ columns.gs_level }};
        indexMap["series"] = {{ columns.job_series }};

        // Current hash value
        var hashFilter = getHashFilter();
        // Concatenate priority_area and type for Isotope filtering
        // + hashFilter["status"];

        if (hashFilter) {
            // Repaint Isotope container with current filters and sorts
            for (var key in hashFilter) {
              if(key != "competency" && key != "competencygroup") {
                var columnIndex = indexMap[key];
                activeFilters[columnIndex] = new Set();
                activeFilters[columnIndex].add(hashFilter[key]);
                // Toggle checked status of sort button
                // Toggle checked status of filter buttons
                $(".tr-filter-list").find("[data-filter='" + hashFilter["series"] + "'],[data-filter='" + hashFilter["level"] + "']").addClass("active").attr("aria-checked", "true");
              } else if (key == "competency") {
                var comp= hashFilter[key];
                var compGroup = hashFilter["competencygroup"];
                activeFilters['competency'] = new Set();
                activeFilters['competency'].add(hashFilter[key]);
                let $groupElem = $('#competency-group-button-' + compGroup.toLowerCase());
                $groupElem.attr('aria-label', ' ' + compGroup + ', expanded');
                let $parentElem = $('.' + compGroup.toLowerCase());
                $('.' + compGroup.toLowerCase()).find(".career-competency-input-groups").show();
                var $elemToCheck = $('#'+compGroup.toLowerCase() + '-' + hashFilter[key]);
                $elemToCheck.prop('checked', true);
                $('.' + compGroup.toLowerCase()).find('.fa').removeClass('fa-plus');
                $('.' + compGroup.toLowerCase()).find('.fa').addClass('fa-minus');

              }
            }
            table.draw();
        }
    } // onHahschange

    function getHashFilter() {
        var series = location.hash.match(/series=([^&]+)/i);
        var levelRaw = location.hash.match(/level=([^&]+)/i);
        var competencyRaw = location.hash.match(/competency=([^&]+)/i);
        var competencyGroup = location.hash.match(/competencygroup=([^&]+)/i);

        var level = levelRaw[1].replaceAll('%20', ' ');
        var competency = competencyRaw[1].toLowerCase().replaceAll('%20', '-').replaceAll(',', '');
        seriesMap = {};
        seriesMap["0501"] = "0501 Financial Administration and Program Support";
        seriesMap["0560"] = "0560 Budget Analysis";
        seriesMap["0511"] = "0511 Auditing";
        seriesMap["0510"] = "0510 Accounting";

        // Set up a hashFilter array
        var hashFilter = {};
        // Populate array with matches and sorts using ternary logic
        hashFilter["series"] = series ? seriesMap[series[1]] : "*";
        hashFilter["level"] = level? level : "*";
        hashFilter["competency"] = competency ? competency : "*";
        hashFilter["competencygroup"] = competencyGroup ? competencyGroup[1] : "*";


        return hashFilter;
    } // getHashFilter

    // When the hash changes, run onHashchange

    // When the page loads for the first time, run onHashChange
    onHashChange();


});
</script>
{% endif %}
